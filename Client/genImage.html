<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EternaPicSHT Studio</title>
    <link rel="stylesheet" href="assets/css/genr.css" />
    <link rel="stylesheet" href="/assets/css/styles.css" />
    <link rel="stylesheet" href="/assets/css/features.css" />
    <link rel="stylesheet" href="/assets/css/hero.css" />
    <link rel="stylesheet" href="/assets/css/footer.css" />
  </head>
  <body>
    <div id="header"></div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button class="tab-button active" data-tab="ascii-art">
        <span class="tab-icon"></span>T·∫°o ASCII Art
      </button>
      <button class="tab-button" data-tab="background">
        <span class="tab-icon"></span>T·∫°o ·∫¢nh B·ªëi C·∫£nh
      </button>
      <button class="tab-button" data-tab="outfit">
        <span class="tab-icon"></span>ƒê·ªïi Trang Ph·ª•c/T√≥c
      </button>
    </div>

    <div class="container">
      <!-- ASCII Art Tab -->
      <div class="tab-content active" id="ascii-art-tab">
        <div class="content-wrapper">
          <!-- Upload Section -->
          <div class="upload-box">
            <h3>T·∫£i ·∫£nh l√™n</h3>
            <div class="upload-area" id="upload-area">
              <div class="upload-content">
                <img
                  src="https://cdn-icons-png.flaticon.com/512/1829/1829588.png"
                  alt="upload"
                  class="upload-icon"
                />
                <p><strong>K√©o th·∫£ ho·∫∑c t·∫£i ·∫£nh t·∫°i ƒë√¢y</strong></p>
                <p class="small">ho·∫∑c nh·∫•n ƒë·ªÉ ch·ªçn t·ªáp</p>
                <input type="file" id="file-input" hidden accept="image/*" />
                <button class="btn" id="choose-btn">Ch·ªçn ·∫£nh</button>
              </div>
            </div>
          </div>

          <!-- Settings Section -->
          <div class="settings-box">
            <h3>C√†i ƒë·∫∑t</h3>

            <label>Ch·∫ø ƒë·ªô ·∫£nh</label>
            <select id="prompt-select">
              <option value="">Loading prompts...</option>
            </select>

            <label>Width: 80 characters</label>
            <input type="range" min="40" max="200" value="80" />

            <label>D√°ng ƒë·ª©ng</label>
            <select>
              <option>Nghi√™ng v·ªÅ b√™n tr√°i</option>
              <option>Nghi√™ng v·ªÅ b√™n ph·∫£i</option>
              <option>Nh√¨n v·ªÅ gi·ªØa</option>
            </select>

            <button class="download-btn" id="generate-btn">
              <span></span>T·∫°o ·∫£nh
            </button>
          </div>
          <div class="output-box">
            <h3>K·∫øt qu·∫£</h3>
            <div class="output-area" id="output-area">
              <div class="output-placeholder">
                <p>·∫¢nh k·∫øt qu·∫£ s·∫Ω xu·∫•t hi·ªán t·∫°i ƒë√¢y</p>
              </div>
            </div>
            <div class="output-info" id="output-info" style="display: none">
              <p>
                <strong>Ch·∫ø ƒë·ªô:</strong> <span id="output-prompt-name"></span>
              </p>
              <p>
                <strong>M√¥ t·∫£:</strong> <span id="output-prompt-title"></span>
              </p>
            </div>
            <button
              class="download-btn download-result"
              id="download-btn"
              style="display: none"
            >
              <span>‚¨á</span>T·∫£i ·∫£nh
            </button>
          </div>
        </div>
      </div>

      <!-- Background Image Tab -->
      <div class="tab-content" id="background-tab">
        <div class="content-wrapper">
          <div class="upload-box">
            <h3>T·∫£i ·∫£nh l√™n</h3>
            <div class="upload-area" id="bg-upload-area">
              <div class="upload-content">
                <img
                  src="https://cdn-icons-png.flaticon.com/512/1829/1829588.png"
                  alt="upload"
                  class="upload-icon"
                />
                <p><strong>K√©o th·∫£ ho·∫∑c t·∫£i ·∫£nh t·∫°i ƒë√¢y</strong></p>
                <p class="small">ho·∫∑c nh·∫•n ƒë·ªÉ ch·ªçn t·ªáp</p>
                <input type="file" id="bg-file-input" hidden accept="image/*" />
                <button class="btn" id="bg-choose-btn">Ch·ªçn ·∫£nh</button>
              </div>
            </div>
          </div>

          <div class="settings-box">
            <h3>C√†i ƒë·∫∑t</h3>

            <label>Lo·∫°i b·ªëi c·∫£nh</label>
            <select id="bg-type-select">
              <option value="">Ch·ªçn lo·∫°i b·ªëi c·∫£nh</option>
              <option value="nature">Thi√™n nhi√™n</option>
              <option value="urban">Th√†nh ph·ªë</option>
              <option value="abstract">Tr·ª´u t∆∞·ª£ng</option>
              <option value="fantasy">Gi·∫£ t∆∞·ªüng</option>
            </select>

            <label>M√¥ t·∫£ b·ªëi c·∫£nh</label>
            <textarea
              id="bg-description"
              placeholder="M√¥ t·∫£ b·ªëi c·∫£nh m√† b·∫°n mu·ªën t·∫°o..."
              rows="4"
            ></textarea>

            <button class="download-btn" id="bg-generate-btn">
              <span></span>T·∫°o B·ªëi C·∫£nh
            </button>
          </div>

          <div class="output-box">
            <h3>K·∫øt qu·∫£</h3>
            <div class="output-area" id="bg-output-area">
              <div class="output-placeholder">
                <p>·∫¢nh b·ªëi c·∫£nh s·∫Ω xu·∫•t hi·ªán t·∫°i ƒë√¢y</p>
              </div>
            </div>
            <button
              class="download-btn download-result"
              id="bg-download-btn"
              style="display: none"
            >
              <span>‚¨á</span>T·∫£i ·∫¢nh
            </button>
          </div>
        </div>
      </div>

      <!-- Outfit Tab -->
      <div class="tab-content" id="outfit-tab">
        <div class="content-wrapper">
          <div class="upload-box">
            <h3>T·∫£i ·∫£nh l√™n</h3>
            <div class="upload-area" id="outfit-upload-area">
              <div class="upload-content">
                <img
                  src="https://cdn-icons-png.flaticon.com/512/1829/1829588.png"
                  alt="upload"
                  class="upload-icon"
                />
                <p><strong>K√©o th·∫£ ho·∫∑c t·∫£i ·∫£nh t·∫°i ƒë√¢y</strong></p>
                <p class="small">ho·∫∑c nh·∫•n ƒë·ªÉ ch·ªçn t·ªáp</p>
                <input
                  type="file"
                  id="outfit-file-input"
                  hidden
                  accept="image/*"
                />
                <button class="btn" id="outfit-choose-btn">Ch·ªçn ·∫£nh</button>
              </div>
            </div>
          </div>

          <div class="settings-box">
            <h3>C√†i ƒë·∫∑t</h3>

            <label>Lo·∫°i trang ph·ª•c/t√≥c</label>
            <select id="outfit-type-select">
              <option value="">Ch·ªçn lo·∫°i</option>
              <option value="casual">√Åo ph√¥ng th∆∞·ªùng ng√†y</option>
              <option value="formal">√Åo vest ch√≠nh th·ª©c</option>
              <option value="elegant">V√°y l·ªông l·∫´y</option>
              <option value="sporty">√Åo th·ªÉ thao</option>
            </select>

            <label>Ki·ªÉu t√≥c</label>
            <select id="outfit-hairstyle-select">
              <option value="">Ch·ªçn ki·ªÉu t√≥c</option>
              <option value="long">T√≥c d√†i</option>
              <option value="short">T√≥c ng·∫Øn</option>
              <option value="curly">T√≥c xoƒÉn</option>
              <option value="straight">T√≥c th·∫≥ng</option>
            </select>

            <label>M√¥ t·∫£ chi ti·∫øt</label>
            <textarea
              id="outfit-description"
              placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ trang ph·ª•c/t√≥c m√† b·∫°n mu·ªën..."
              rows="4"
            ></textarea>

            <button class="download-btn" id="outfit-generate-btn">
              <span></span>Thay ƒê·ªïi
            </button>
          </div>

          <div class="output-box">
            <h3>K·∫øt qu·∫£</h3>
            <div class="output-area" id="outfit-output-area">
              <div class="output-placeholder">
                <p>·∫¢nh k·∫øt qu·∫£ s·∫Ω xu·∫•t hi·ªán t·∫°i ƒë√¢y</p>
              </div>
            </div>
            <button
              class="download-btn download-result"
              id="outfit-download-btn"
              style="display: none"
            >
              <span></span>T·∫£i ·∫¢nh
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Tab switching
      const tabButtons = document.querySelectorAll(".tab-button");
      const tabContents = document.querySelectorAll(".tab-content");

      tabButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const tabName = button.dataset.tab;

          // Remove active from all buttons and contents
          tabButtons.forEach((btn) => btn.classList.remove("active"));
          tabContents.forEach((content) => content.classList.remove("active"));

          // Add active to clicked button and corresponding content
          button.classList.add("active");
          document.getElementById(`${tabName}-tab`).classList.add("active");
        });
      });

      // ASCII Art Generation
      const uploadArea = document.getElementById("upload-area");
      const fileInput = document.getElementById("file-input");
      const chooseBtn = document.getElementById("choose-btn");
      const promptSelect = document.getElementById("prompt-select");
      const generateBtn = document.getElementById("generate-btn");
      let selectedFile = null;

      uploadArea.addEventListener("click", () => fileInput.click());
      chooseBtn.addEventListener("click", () => fileInput.click());

      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = "#666";
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.style.borderColor = "#ccc";
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (file) handleFile(file);
      });

      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) handleFile(file);
      });

      function handleFile(file) {
        selectedFile = file;
        const reader = new FileReader();
        reader.onload = () => {
          uploadArea.innerHTML = `
            <img src="${reader.result}" 
              style="max-width:100%; border-radius:8px; display:block; margin:auto;">
          `;
        };
        reader.readAsDataURL(file);
      }

      // Load prompts t·ª´ API
      async function loadPrompts() {
        try {
          const response = await fetch("/api/prompts");
          const prompts = await response.json();
          promptSelect.innerHTML = '<option value="">Ch·ªçn ch·∫ø ƒë·ªô ·∫£nh</option>';
          prompts.forEach((prompt) => {
            if (prompt.isActive) {
              const option = document.createElement("option");
              option.value = prompt.name;
              option.textContent = prompt.title || prompt.name;
              promptSelect.appendChild(option);
            }
          });
        } catch (error) {
          console.error("L·ªói load prompts:", error);
          promptSelect.innerHTML = '<option value="">L·ªói load prompts</option>';
        }
      }

      // Generate ·∫£nh
      let currentImageUrl = null;

      generateBtn.addEventListener("click", async () => {
        if (!selectedFile) {
          alert("Vui l√≤ng ch·ªçn ·∫£nh tr∆∞·ªõc");
          return;
        }
        if (!promptSelect.value) {
          alert("Vui l√≤ng ch·ªçn ch·∫ø ƒë·ªô ·∫£nh");
          return;
        }

        const token = localStorage.getItem("token");

        const formData = new FormData();
        formData.append("promptName", promptSelect.value);
        formData.append("image", selectedFile);

        try {
          generateBtn.disabled = true;
          generateBtn.innerHTML = "<span>‚è≥</span>ƒêang x·ª≠ l√Ω...";

          const response = await fetch("/api/ai/generate", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            currentImageUrl = result.localPath;
            displayOutput(result);
          } else {
            alert("L·ªói: " + (result.error || result.message));
          }
        } catch (error) {
          console.error("L·ªói:", error);
          alert("L·ªói khi t·∫°o ·∫£nh: " + error.message);
        } finally {
          generateBtn.disabled = false;
          generateBtn.innerHTML = "<span>‚ú®</span>T·∫°o ·∫£nh";
        }
      });

      // Hi·ªÉn th·ªã k·∫øt qu·∫£ output
      function displayOutput(result) {
        const outputArea = document.getElementById("output-area");
        const outputInfo = document.getElementById("output-info");
        const downloadBtn = document.getElementById("download-btn");

        // Hi·ªÉn th·ªã ·∫£nh
        outputArea.innerHTML = `
          <img src="${result.localPath}?t=${Date.now()}" alt="Generated image">
        `;

        // Hi·ªÉn th·ªã th√¥ng tin
        document.getElementById("output-prompt-name").textContent =
          result.promptName;
        document.getElementById("output-prompt-title").textContent =
          result.promptTitle;
        outputInfo.style.display = "block";

        // Hi·ªÉn th·ªã n√∫t download
        downloadBtn.style.display = "flex";
        downloadBtn.onclick = () =>
          downloadImage(result.localPath, result.promptName);
      }

      // Download ·∫£nh
      function downloadImage(imagePath, promptName) {
        const link = document.createElement("a");
        link.href = imagePath;
        link.download = `${promptName}_${Date.now()}.jpg`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // Load prompts khi page load
      document.addEventListener("DOMContentLoaded", loadPrompts);

      // Background Image Generation
      const bgUploadArea = document.getElementById("bg-upload-area");
      const bgFileInput = document.getElementById("bg-file-input");
      const bgChooseBtn = document.getElementById("bg-choose-btn");
      const bgTypeSelect = document.getElementById("bg-type-select");
      const bgGenerateBtn = document.getElementById("bg-generate-btn");
      let bgSelectedFile = null;

      bgUploadArea.addEventListener("click", () => bgFileInput.click());
      bgChooseBtn.addEventListener("click", () => bgFileInput.click());

      bgUploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        bgUploadArea.style.borderColor = "#666";
      });

      bgUploadArea.addEventListener("dragleave", () => {
        bgUploadArea.style.borderColor = "#ccc";
      });

      bgUploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (file) handleBgFile(file);
      });

      bgFileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) handleBgFile(file);
      });

      function handleBgFile(file) {
        bgSelectedFile = file;
        const reader = new FileReader();
        reader.onload = () => {
          bgUploadArea.innerHTML = `
            <img src="${reader.result}" 
              style="max-width:100%; border-radius:8px; display:block; margin:auto;">
          `;
        };
        reader.readAsDataURL(file);
      }

      bgGenerateBtn.addEventListener("click", async () => {
        if (!bgSelectedFile) {
          alert("Vui l√≤ng ch·ªçn ·∫£nh tr∆∞·ªõc");
          return;
        }
        if (!bgTypeSelect.value) {
          alert("Vui l√≤ng ch·ªçn lo·∫°i b·ªëi c·∫£nh");
          return;
        }

        const token = localStorage.getItem("token");
        const bgDescription = document.getElementById("bg-description").value;

        const formData = new FormData();
        formData.append("type", bgTypeSelect.value);
        formData.append("description", bgDescription);
        formData.append("image", bgSelectedFile);

        try {
          bgGenerateBtn.disabled = true;
          bgGenerateBtn.innerHTML = "<span>‚è≥</span>ƒêang x·ª≠ l√Ω...";

          const response = await fetch("/api/ai/generate-background", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            displayBgOutput(result);
          } else {
            alert("L·ªói: " + (result.error || result.message));
          }
        } catch (error) {
          console.error("L·ªói:", error);
          alert("L·ªói khi t·∫°o b·ªëi c·∫£nh: " + error.message);
        } finally {
          bgGenerateBtn.disabled = false;
          bgGenerateBtn.innerHTML = "<span></span>T·∫°o B·ªëi C·∫£nh";
        }
      });

      function displayBgOutput(result) {
        const bgOutputArea = document.getElementById("bg-output-area");
        const bgDownloadBtn = document.getElementById("bg-download-btn");

        bgOutputArea.innerHTML = `
          <img src="${
            result.localPath
          }?t=${Date.now()}" alt="Generated background">
        `;

        bgDownloadBtn.style.display = "flex";
        bgDownloadBtn.onclick = () =>
          downloadImage(result.localPath, `background_${bgTypeSelect.value}`);
      }

      // Outfit Tab
      const outfitUploadArea = document.getElementById("outfit-upload-area");
      const outfitFileInput = document.getElementById("outfit-file-input");
      const outfitChooseBtn = document.getElementById("outfit-choose-btn");
      const outfitTypeSelect = document.getElementById("outfit-type-select");
      const outfitHairstyleSelect = document.getElementById(
        "outfit-hairstyle-select"
      );
      const outfitGenerateBtn = document.getElementById("outfit-generate-btn");
      let outfitSelectedFile = null;

      outfitUploadArea.addEventListener("click", () => outfitFileInput.click());
      outfitChooseBtn.addEventListener("click", () => outfitFileInput.click());

      outfitUploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        outfitUploadArea.style.borderColor = "#666";
      });

      outfitUploadArea.addEventListener("dragleave", () => {
        outfitUploadArea.style.borderColor = "#ccc";
      });

      outfitUploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (file) handleOutfitFile(file);
      });

      outfitFileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) handleOutfitFile(file);
      });

      function handleOutfitFile(file) {
        outfitSelectedFile = file;
        const reader = new FileReader();
        reader.onload = () => {
          outfitUploadArea.innerHTML = `
            <img src="${reader.result}" 
              style="max-width:100%; border-radius:8px; display:block; margin:auto;">
          `;
        };
        reader.readAsDataURL(file);
      }

      outfitGenerateBtn.addEventListener("click", async () => {
        if (!outfitSelectedFile) {
          alert("Vui l√≤ng ch·ªçn ·∫£nh tr∆∞·ªõc");
          return;
        }
        if (!outfitTypeSelect.value || !outfitHairstyleSelect.value) {
          alert("Vui l√≤ng ch·ªçn lo·∫°i trang ph·ª•c v√† ki·ªÉu t√≥c");
          return;
        }

        const token = localStorage.getItem("token");
        const outfitDescription =
          document.getElementById("outfit-description").value;

        const formData = new FormData();
        formData.append("type", outfitTypeSelect.value);
        formData.append("hairstyle", outfitHairstyleSelect.value);
        formData.append("description", outfitDescription);
        formData.append("image", outfitSelectedFile);

        try {
          outfitGenerateBtn.disabled = true;
          outfitGenerateBtn.innerHTML = "<span>‚è≥</span>ƒêang x·ª≠ l√Ω...";

          const response = await fetch("/api/ai/generate-outfit", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            displayOutfitOutput(result);
          } else {
            alert("L·ªói: " + (result.error || result.message));
          }
        } catch (error) {
          console.error("L·ªói:", error);
          alert("L·ªói khi thay ƒë·ªïi trang ph·ª•c: " + error.message);
        } finally {
          outfitGenerateBtn.disabled = false;
          outfitGenerateBtn.innerHTML = "<span></span>Thay ƒê·ªïi";
        }
      });

      function displayOutfitOutput(result) {
        const outfitOutputArea = document.getElementById("outfit-output-area");
        const outfitDownloadBtn = document.getElementById(
          "outfit-download-btn"
        );

        outfitOutputArea.innerHTML = `
          <img src="${result.localPath}?t=${Date.now()}" alt="Generated outfit">
        `;

        outfitDownloadBtn.style.display = "flex";
        outfitDownloadBtn.onclick = () =>
          downloadImage(result.localPath, `outfit_${outfitTypeSelect.value}`);
      }
    </script>

    <!-- Quick Guide Section -->
    <div class="quick-guide">
      <h3>üìñ H∆∞·ªõng d·∫´n nhanh</h3>
      <div class="guide-content">
        <p><strong>T·∫°o ASCII Art:</strong></p>
        <ol>
          <li>T·∫£i ·∫£nh - Ch·ªçn ·∫£nh ho·∫∑c k√©o th·∫£ ·∫£nh v√†o √¥ 'T·∫£i ·∫£nh'.</li>
          <li>
            Ch·∫ø ƒë·ªô ·∫£nh - H√£y nh·∫≠p m·ªôt √Ω t∆∞·ªüng ng·∫Øn g·ªçn (VD: 'm·ªôt hi·ªáp sƒ© trong
            r·ª´ng r·∫≠m').
          </li>
          <li>
            T·∫°o ·∫£nh - Nh·∫•n n√∫t 'T·∫°o ·∫£nh' ƒë·ªÉ b·∫Øt ƒë·∫ßu render (qu√° tr√¨nh n√†y m·∫•t
            v√†i ph√∫t v√¨ t√≠nh to√°n).
          </li>
          <li>
            T·∫£i v·ªÅ - Khi ho√†n th√†nh, nh·∫•n n√∫t 'T·∫£i ·∫£nh' ƒë·ªÉ t·∫£i k·∫øt qu·∫£ v·ªÅ m√°y.
          </li>
        </ol>
        <p style="margin-top: 15px"><strong>T·∫°o ·∫¢nh B·ªëi C·∫£nh:</strong></p>
        <ol>
          <li>Chuy·ªÉn sang tab 'T·∫°o ·∫¢nh B·ªëi C·∫£nh'.</li>
          <li>T·∫£i ·∫£nh ƒë·∫ßu v√†o v√† ch·ªçn lo·∫°i b·ªëi c·∫£nh.</li>
          <li>M√¥ t·∫£ chi ti·∫øt b·ªëi c·∫£nh mu·ªën t·∫°o.</li>
          <li>Nh·∫•n 'T·∫°o B·ªëi C·∫£nh' v√† ch·ªù k·∫øt qu·∫£.</li>
        </ol>
      </div>
    </div>

    <div id="footer"></div>
    <script src="/assets/js/auth-utils.js"></script>
    <script src="/assets/js/main.js"></script>
  </body>
</html>
